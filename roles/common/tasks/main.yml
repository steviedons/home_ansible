- name: Create {{ group }}
  group: name={{ group }} state=present

- name: Create {{ user }} account
  user:
    name={{ user }}
    comment="{{ user_name }}"
    group={{ user }}
    createhome=yes
    home=/home/{{ user }}
    shell=/bin/bash
    password={{ steve_password }}
    state=present

- name: ensure ssh directory exists for {{ user }}
  file: dest=/home/{{ user }}/.ssh owner={{ user }} group={{ group }} state=directory mode=700

- name: Setup | authorized key upload
  authorized_key: user={{ createuser }}
      key="{{ steve_key }}"
      path='/home/{{ createuser }}/.ssh/authorized_keys'
      manage_dir=no

- name: update ssh parameters
  lineinfile:
    dest=/etc/ssh/sshd_config
    state=present
    regexp=^{{ item.key }}
    line="{{ item.key }} {{ item.value }}"
    insertafter=EOF
  with_items:
    - { key: 'PermitRootLogin', value: 'no' }
    - { key: 'LoginGraceTime', value: '20' }
    - { key: 'X11Forwarding', value: 'no' }
    - { key: 'ClientAliveInterval', value: '30' }
    - { key: 'ClientAliveCountMax', value: '1000' }
  notify:
  - restart ssh

- name: get epel-repo rpm RHEL6
  get_url: dest=/tmp/epel-release.rpm  url=http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version|int == 6

- name: get epel-repo for RHEL7
  get_url: dest=/tmp/epel-release.rpm url=http://www.mirrorservice.org/sites/dl.fedoraproject.org/pub/epel//7/x86_64/e/epel-release-7-5.noarch.rpm
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version|int == 7

- name: install epel-repo rpm
  yum: pkg=/tmp/epel-release.rpm state=installed

- name: install my packages
  yum: pkg={{ item }} state=installed
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version|int == 6
  with_items:
      - policycoreutils-python
      - mod_ssl
#       - screen
#       - policycoreutils-python 
#       - iotop 
#       - yum-plugin-ps 
      - yum-cron   
#       - iptraf 
#       - acpid 
#       - man 
#       - bind-utils 
#       - vim-enhanced 
#       - nc 
#       - zip 
#       - unzip 
#       - wget 
      - etckeeper 
#       - links 
#       - screen 
      - yum-utils 
#       - lsof 
#       - bash-completion 
#       - ddrescue 
#       - dos2unix 
#       - dstat 
#       - lftp 
#       - links 
#       - smartmontools 
#       - nmap 
#       - rng-tools 
#       - sysstat 
#       - git
      - htop

- name: activate autoupdate
  service: enabled=yes state=started name=yum-cron

- name: initialize etckeeper
  command: /usr/bin/etckeeper init creates=/etc/.git/description

- name: make first commit
  command: /usr/bin/etckeeper commit -m "init" creates=/etc/.git/COMMIT_EDITMSG

