- name: Sudoers | Copy sudoers file for safety
  command: cp -f /etc/sudoers /etc/sudoers.tmp

- name: Sudoers | Create sudoers file backup
  command: cp -f /etc/sudoers /etc/sudoers.bak

- name: Add users to sudoers file parameters
  lineinfile:
   dest=/etc/sudoers
   state=present
   backup=yes
   regexp=^{{ item.key }}
   line="{{ item.key }} {{ item.value }}"
   insertafter=EOF
  with_items:
   - { key: '{{ createuser }}', value: 'ALL=(ALL) NOPASSWD:ALL' }
   - { key: 'Defaults', value: 'env_keep+=SSH_AUTH_SOCK' }
   
- name: Sudoers | Final sudoers file check and copy
  shell: visudo -q -c -f /etc/sudoers.tmp && cp -f /etc/sudoers.tmp /etc/sudoers
